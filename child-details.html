<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shah EIR - Editable Profile</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { padding-top: 8rem; }
</style>
</head>
<body class="bg-gray-100">

<!-- Header -->
<header class="fixed top-0 left-0 right-0 bg-white shadow p-4 z-30 flex flex-col md:flex-row md:items-center md:justify-between space-y-2 md:space-y-0">
  <div class="flex items-center space-x-4">
    <img src="https://cdn.jsdelivr.net/gh/eirshah/assets/images/logo.png" alt="Logo" class="h-10 w-10">
    <h1 class="text-2xl font-bold text-gray-800">All Children</h1>
  </div>
</header>

<!-- Profile Card -->
<section id="childProfileCard" class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-8 font-sans">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold text-gray-800">Child Profile</h1>
    <div id="actionButtons" class="space-x-2">
      <button id="editProfileBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow">Edit</button>
      <button id="saveProfileBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow hidden">Save</button>
      <button id="cancelProfileBtn" class="px-4 py-2 bg-gray-400 text-white rounded-lg shadow hidden">Cancel</button>
    </div>
  </div>

  <div id="notification" class="hidden mb-4 p-3 rounded-lg text-white font-medium"></div>
  <div id="profileContainer" class="space-y-4"></div>
</section>

<script>
/* --------------------- CONFIG --------------------- */
const webAppUrl = "https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec";
const enableRemoteSave = true; // set to false if you want local only

const profileFieldsList = [
  "currently_living","unique_id","foolhumaa_form_number","beneficiary_national_id",
  "beneficiary_name","dob","sex","island_residence","current_address",
  "mother_name","mother_national_id","primary_contact","caregiver_name",
  "caregiver_id","caregiver_contact","country","birth_weight"
];

const dropdownOptions = {
  sex: ["Male", "Female", "Other"],
  currently_living: ["Yes", "No"],
  country: ["Maldives", "India", "Sri Lanka", "Other"]
};

let originalData = {};
let childId = "";

/* --------------------- UTILS --------------------- */
function showNotice(message, type="info") {
  const note = document.getElementById("notification");
  note.innerText = message;
  note.className = `mb-4 p-3 rounded-lg font-medium ${
    type==="success"?"bg-green-500 text-white":
    type==="error"?"bg-red-500 text-white":
    type==="warning"?"bg-yellow-500 text-black":
    "bg-blue-500 text-white"
  }`;
  note.classList.remove("hidden");
  setTimeout(()=> note.classList.add("hidden"), 4000);
}

function getChildIdFromURL() {
  const params = new URLSearchParams(window.location.search);
  return params.get("id") || "default_child";
}

/* --------------------- RENDER --------------------- */
function renderProfile(child, editable=false){
  const container = document.getElementById("profileContainer");
  container.innerHTML = "";
  const fragment = document.createDocumentFragment();

  profileFieldsList.forEach(key => {
    const labelText = key.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
    const value = child[key] || "";

    const fieldDiv = document.createElement("div");
    fieldDiv.className = "flex items-center space-x-4";

    if(editable && dropdownOptions[key]){
      const optionsHtml = dropdownOptions[key].map(opt =>
        `<option value="${opt}" ${opt===value?'selected':''}>${opt}</option>`).join("");
      fieldDiv.innerHTML = `
        <label class="w-1/3 font-semibold text-gray-700">${labelText}:</label>
        <select data-key="${key}" class="border border-gray-300 rounded-md p-2 w-2/3 bg-white">
          ${optionsHtml}
        </select>
      `;
    } else {
      fieldDiv.innerHTML = `
        <label class="w-1/3 font-semibold text-gray-700">${labelText}:</label>
        <input type="text" value="${value}" data-key="${key}" 
          class="border border-gray-300 rounded-md p-2 w-2/3 ${editable?'bg-white':'bg-gray-50'}"
          ${editable?'':'readonly'} />
      `;
    }

    fragment.appendChild(fieldDiv);
  });

  container.appendChild(fragment);
}

/* --------------------- LOAD --------------------- */
function loadProfile(){
  childId = getChildIdFromURL();
  const cacheKey = "childProfile_" + childId;
  const cached = localStorage.getItem(cacheKey);

  if(cached){
    originalData = JSON.parse(cached);
    renderProfile(originalData);
    showNotice("Loaded profile from local storage.", "info");
  } else {
    originalData = {};
    profileFieldsList.forEach(f=>originalData[f]="");
    renderProfile(originalData);
    showNotice("New profile initialized.", "info");
  }
}

/* --------------------- BUTTONS --------------------- */
document.getElementById("editProfileBtn").addEventListener("click", ()=>{
  renderProfile(originalData,true);
  document.getElementById("editProfileBtn").classList.add("hidden");
  document.getElementById("saveProfileBtn").classList.remove("hidden");
  document.getElementById("cancelProfileBtn").classList.remove("hidden");
  showNotice("Editing mode enabled.", "warning");
});

document.getElementById("cancelProfileBtn").addEventListener("click", ()=>{
  renderProfile(originalData,false);
  document.getElementById("editProfileBtn").classList.remove("hidden");
  document.getElementById("saveProfileBtn").classList.add("hidden");
  document.getElementById("cancelProfileBtn").classList.add("hidden");
  showNotice("Changes discarded.", "info");
});

document.getElementById("saveProfileBtn").addEventListener("click", async ()=>{
  const container = document.getElementById("profileContainer");
  const inputs = container.querySelectorAll("input, select");
  const payload = {};
  inputs.forEach(i=>payload[i.dataset.key]=i.value);

  // 1️⃣ Local save
  originalData = {...payload};
  localStorage.setItem("childProfile_" + childId, JSON.stringify(originalData));
  renderProfile(originalData,false);
  document.getElementById("editProfileBtn").classList.remove("hidden");
  document.getElementById("saveProfileBtn").classList.add("hidden");
  document.getElementById("cancelProfileBtn").classList.add("hidden");
  showNotice("Changes saved locally!", "success");

  // 2️⃣ Remote save
  if(enableRemoteSave && webAppUrl){
    try {
      const response = await fetch(webAppUrl,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({action:"update", key:childId, data:payload})
      });
      const result = await response.json();
      showNotice(result.message || "Saved remotely!", "success");
    } catch(err){
      console.error(err);
      showNotice("Remote save failed.", "error");
    }
  }
});

/* --------------------- INIT --------------------- */
window.onload = loadProfile;
</script>

</body>
</html>
